map $http_upgrade $connection_upgrade {
  default upgrade;
  ''    close;
}

map $request_method $is_preflight {
    default 0;
    OPTIONS 1;
}

add_header Floxy-Version "{{ floxy_version }}";

server {
  listen {{ floxy_http_port }};
  listen [::]:{{ floxy_http_port }};
  server_name _;

  location = /health {
    access_log off;
    return 204;
  }

  location / {
    return 308 https://$host{% if floxy_https_port != 443 %}:{{ floxy_https_port }}{% endif %}$request_uri;
  }
}

upstream webapp_http {
  server {{ webapp_ipv4 }}:{{ webapp_http_port }};
}
{% if let Some(port) = webapp_https_port %}
upstream webapp_https {
  server {{ webapp_ipv4 }}:{{ port }};
}
{% else -%}
{% endif %}
server {
  listen {{ floxy_https_port }} ssl;
  listen [::]:{{ floxy_https_port }} ssl;
  server_name _;

  include conf.d/include/ssl.conf;

  add_header Access-Control-Allow-Origin "*" always;
  add_header Access-Control-Allow-Methods "*" always;
  add_header Access-Control-Allow-Headers "*" always;

  if ($is_preflight) {
    return 204;
  }

  location = /api/v2/imports {
    proxy_pass http://{{ flecs_gateway }}:8951/;

    include conf.d/include/proxy_headers.conf;

    proxy_request_buffering off;
    client_max_body_size 8G;
  }

  location /api/ {
    proxy_pass http://{{ flecs_gateway }}:8951/;

    include conf.d/include/proxy_headers.conf;
  }

  location /ui/ {
    {% if let Some(port) = webapp_https_port %}
    proxy_pass https://webapp_https/ui/;
    proxy_next_upstream error http_502;
    error_page 502 = @ui_fallback;
    {% else %}
    proxy_pass http://webapp_http/ui/;
    {% endif %}

    include conf.d/include/proxy_headers.conf;
  }
  {% if let Some(port) = webapp_https_port %}
  location @ui_fallback {
    proxy_pass http://webapp_http;
    include conf.d/include/proxy_headers.conf;
  }
  {% else -%}
  {% endif %}
  include /etc/nginx/conf.d/floxy/instances/*.conf;

  location = / {
    return 301 /ui/;
  }

  location / {
    return 404;
  }
}

include /etc/nginx/conf.d/floxy/servers/*.conf;
{#+ #}